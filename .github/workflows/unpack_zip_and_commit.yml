
name: Unpack ZIP and Commit Project Files

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  unpack-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Install unzip
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip

      - name: Check for ZIP file
        id: findzip
        run: |
          ZIPNAME="KingOfKingsJukebox_Full.zip"
          if [ -f "$ZIPNAME" ]; then
            echo "zip_found=true" >> $GITHUB_OUTPUT
            echo "ZIP=$ZIPNAME" >> $GITHUB_OUTPUT
          else
            echo "zip_found=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Unzip
        run: |
          ZIPNAME="${{ steps.findzip.outputs.ZIP }}"
          mkdir extracted
          unzip -o "$ZIPNAME" -d extracted

      - name: Copy extracted
        run: |
          if [ "$(ls -A extracted | wc -l)" -eq 1 ] && [ -d "extracted/$(ls extracted)" ]; then
            TOPDIR=$(ls extracted)
            cp -a "extracted/$TOPDIR/." .
          else
            cp -a extracted/. .
          fi

      - name: Commit and push
        run: |
          ZIPNAME="${{ steps.findzip.outputs.ZIP }}"
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git rm -f "$ZIPNAME" || true
          rm -rf extracted
          git add -A
          git commit -m "Unpacked ZIP"
          git push